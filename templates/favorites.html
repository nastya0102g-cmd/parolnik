<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–∞—Ä–æ–ª–∏</title>
    <link rel="stylesheet" href="../static/css/style.css?v=2">
</head>
<body>
    <div class="container">
        <div class="card header">
            <div class="title">‚≠ê –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–∞—Ä–æ–ª–∏</div>
            <div>
                <button class="icon-btn" onclick="location.href='/search'">üîç</button>
                <button class="icon-btn" onclick="location.href='/profile'">üë§</button>
                <button class="icon-btn" onclick="location.href='/navigation'">‚Üê</button>
                <button class="icon-btn" id="refreshBtn" title="–û–±–Ω–æ–≤–∏—Ç—å" onclick="loadSavedPasswords()">üîÑ</button>
            </div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>–í–∞—à–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ä–æ–ª–∏</h3>
                <div>
                    <button class="btn" onclick="location.href='/check-password'">
                        + –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–π
                    </button>
                    <button class="btn secondary" onclick="loadSavedPasswords()" style="margin-left: 10px;">
                        –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                    </button>
                </div>
            </div>

            <div id="savedPasswordsList">
                <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã–µ –ø–∞—Ä–æ–ª–∏ -->
                <p style="text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä–æ–ª–µ–π...</p>
            </div>
        </div>

        <div class="cards-grid">
            <div class="card">
                <h3>üìä –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div id="quickStats" style="padding: 15px;">
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
                </div>
                <button class="btn secondary" onclick="location.href='/check-password'">
                    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å
                </button>
            </div>

            <div class="card">
                <h3>üí° –°–æ–≤–µ—Ç—ã –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h3>
                <ul style="padding-left: 20px;">
                    <li>–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–¥–∏–Ω –ø–∞—Ä–æ–ª—å –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤</li>
                    <li>–†–µ–≥—É–ª—è—Ä–Ω–æ –º–µ–Ω—è–π—Ç–µ –≤–∞–∂–Ω—ã–µ –ø–∞—Ä–æ–ª–∏</li>
                    <li>–ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª–∏ –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ</li>
                    <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä –ø–∞—Ä–æ–ª–µ–π</li>
                </ul>
                <button class="btn secondary" onclick="location.href='/search'" style="margin-top: 15px;">
                    –ë–æ–ª—å—à–µ —Å–æ–≤–µ—Ç–æ–≤
                </button>
            </div>
        </div>

        <footer class="contacts">
            <h3>üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
            <a href="tel:+77053652869">+7 (705) 365-28-69</a>
            <a href="https://instagram.com/Rosa_Mirova">@Rosa_Mirova</a>
        </footer>
    </div>

    <script>
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–±—Ä–∞–Ω–Ω—ã–º
    async function loadSavedPasswords() {
        try {
            document.getElementById('savedPasswordsList').innerHTML =
                '<p style="text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä–æ–ª–µ–π...</p>';

            const response = await fetch('/api/saved-passwords');
            if (response.ok) {
                const data = await response.json();
                displayPasswords(data.passwords);
                updateQuickStats(data.passwords);
            } else {
                console.error('Failed to load passwords:', response.status);
                document.getElementById('savedPasswordsList').innerHTML =
                    '<p style="color: var(--red); text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä–æ–ª–µ–π</p>';
            }
        } catch (error) {
            console.error('Error loading passwords:', error);
            document.getElementById('savedPasswordsList').innerHTML =
                '<p style="color: var(--red); text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä–æ–ª–µ–π</p>';
        }
    }

    function displayPasswords(passwords) {
        const container = document.getElementById('savedPasswordsList');

        if (!passwords || passwords.length === 0) {
            container.innerHTML = `
                <div class="card" style="text-align: center; padding: 40px 20px;">
                    <h3>üòî –£ –≤–∞—Å –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π</h3>
                    <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –ø–∞—Ä–æ–ª—å, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é!</p>
                    <button class="btn" onclick="location.href='/check-password'" style="margin-top: 20px;">
                        –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–∞—Ä–æ–ª—è
                    </button>
                </div>
            `;
            return;
        }

        let html = '<div class="data-table"><table><thead><tr><th>ID</th><th>–ü–∞—Ä–æ–ª—å</th><th>–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å</th><th>–î–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';

        passwords.forEach(pwd => {
            const date = pwd.created_at ? new Date(pwd.created_at).toLocaleDateString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            const strengthColor = pwd.strength_score >= 80 ? 'var(--green)' :
                                pwd.strength_score >= 60 ? '#f1c40f' : 'var(--red)';
            const strengthText = pwd.strength_score >= 80 ? '–û—Ç–ª–∏—á–Ω—ã–π' :
                               pwd.strength_score >= 60 ? '–•–æ—Ä–æ—à–∏–π' : '–°–ª–∞–±—ã–π';

            // –ú–∞—Å–∫–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            const maskedPassword = pwd.password_hash.length > 6 ?
                pwd.password_hash.substring(0, 3) + '‚Ä¢'.repeat(pwd.password_hash.length - 6) + pwd.password_hash.substring(pwd.password_hash.length - 3) :
                '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';

            html += `
                <tr>
                    <td>#${pwd.id}</td>
                    <td>
                        <span style="font-family: monospace; background: #f5f5f5; padding: 4px 8px; border-radius: 4px; letter-spacing: 1px;">
                            ${maskedPassword}
                        </span>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="progress-bar" style="width: 100px;">
                                <div class="progress" style="width: ${pwd.strength_score}%; background: ${strengthColor};"></div>
                            </div>
                            <span>${pwd.strength_score}% (${strengthText})</span>
                        </div>
                    </td>
                    <td>${date}</td>
                    <td>
                        <button class="btn secondary" onclick="copyPassword('${pwd.password_hash}', ${pwd.id})"
                                style="padding: 8px 15px; font-size: 14px; margin: 0 5px;">
                            –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button class="btn secondary" onclick="deletePassword(${pwd.id})"
                                style="padding: 8px 15px; font-size: 14px; margin: 0 5px; background: var(--red); color: white;">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table></div>';

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const total = passwords.length;
        const avgScore = Math.round(passwords.reduce((sum, p) => sum + p.strength_score, 0) / total);

        html += `
            <div style="margin-top: 20px; text-align: center; padding: 15px; background: #f9f9f9; border-radius: 10px;">
                <p><strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong> –í—Å–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${total} –ø–∞—Ä–æ–ª–µ–π | –°—Ä–µ–¥–Ω—è—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å: ${avgScore}%</p>
            </div>
        `;

        container.innerHTML = html;
    }

    function updateQuickStats(passwords) {
        const quickStats = document.getElementById('quickStats');
        if (!passwords || passwords.length === 0) {
            quickStats.innerHTML = '<p>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π</p>';
            return;
        }

        const total = passwords.length;
        const avgScore = Math.round(passwords.reduce((sum, p) => sum + p.strength_score, 0) / total);
        const strongCount = passwords.filter(p => p.strength_score >= 80).length;
        const weakCount = passwords.filter(p => p.strength_score < 60).length;

        quickStats.innerHTML = `
            <div style="text-align: center;">
                <div style="font-size: 32px; font-weight: bold; color: var(--orange); margin: 10px 0;">${total}</div>
                <div>–≤—Å–µ–≥–æ –ø–∞—Ä–æ–ª–µ–π</div>
                <div style="margin-top: 15px;">
                    <div>üèÜ –°–∏–ª—å–Ω—ã—Ö: ${strongCount}</div>
                    <div>üìä –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: ${avgScore}%</div>
                    <div>‚ö†Ô∏è –°–ª–∞–±—ã—Ö: ${weakCount}</div>
                </div>
            </div>
        `;
    }

    async function deletePassword(passwordId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–∞—Ä–æ–ª—å?')) return;

        try {
            const response = await fetch(`/api/saved-passwords/${passwordId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    alert('–ü–∞—Ä–æ–ª—å —É–¥–∞–ª–µ–Ω');
                    loadSavedPasswords(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—è');
                }
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—è');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—è');
        }
    }

    function copyPassword(password, passwordId) {
        // –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        navigator.clipboard.writeText(password).then(() => {
            alert('–ü–∞—Ä–æ–ª—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        }).catch(err => {
            console.error('Failed to copy: ', err);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å');
        });
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞—Ä–æ–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        loadSavedPasswords();
    });
    </script>
</body>
</html>